<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <title>HH.ru Parser</title>
</head>
<body>
    <div class="container my-4">
        <div class="row">
            <div class="col text-center">
                <h1>Поиск вакансий</h1>
            </div>
        </div>
    </div>
    <div class="container my-4">
        <div class="row">
            <div class="col">
                <label for="db">База данных: <strong>{{ selected_db }}</strong></label>
                <select name="db" id="db">
                    {% for db_file in db_files %}
                        <option value="{{ db_file }}" {% if db_file == selected_db %}selected{% endif %}>{{ db_file }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col">
                <p>Всего вакансий: {{ pagination.total }}</p>
            </div>
        </div>
    </div>
    <div class="container my-4">
        <div class="row">
            <div class="col">
                <ul class="pagination">
                    {% for page_num in range(1, pagination.pages + 1) %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('index', db=selected_db, page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">HH ID</th>
                            <th scope="col">Вакансия</th>
                            <th scope="col">Город</th>
                            <th scope="col">График</th>
                            <th scope="col">Зарплата</th>
                            <th scope="col">Работодатель</th>
                            <th scope="col">Запрос</th>
                            <th scope="col">Избранное</th>
                            <th scope="col">Статус</th>
                            <th scope="col">Обновлено</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vacancy in vacancies %}
                            <tr class="pt-4 table-group-divider
                            {{ 'bg-success bg-opacity-25' if vacancy[10] == 1 }}
                            {{ 'bg-warning bg-opacity-25' if vacancy[10] == 2 }}
                            {{ 'bg-danger bg-opacity-25' if vacancy[10] == 9 }}
                            {{ 'bg-danger bg-opacity-10' if vacancy[10] == 6 }}
                            {{ 'bg-secondary bg-opacity-25' if vacancy[10] == 7 }}
                            
                            ">
                                <td><a href="https://hh.ru/vacancy/{{ vacancy[0] }}" target="_blank">{{ vacancy[0] }}</a></td>
                                <td><a href="{{ url_for('vacancy_detail', hh_id=vacancy[0], db=selected_db, page_source=pagination.page) }}">{{ vacancy[1] }}</a></td>
                                <td>{{ vacancy[2] }}</td>
                                <td>{{ vacancy[3] }}</td>
                                <td>
                                    {% set salary_from = vacancy[4]['from'] if vacancy[4] else None %}
                                    {% set salary_to = vacancy[4]['to'] if vacancy[4] else None %}
                                    {% set currency = vacancy[4]['currency'] if vacancy[4] else None %}
                                    
                                    {{ ('от {}'.format(salary_from) if salary_from else '') + (' до {}'.format(salary_to) if salary_to else '') + (' {}'.format(currency) if currency else '') if vacancy[4] else '---' }}
                                </td>
                                <td>
                                    <a href="{{ url_for('employer_detail', hh_id=vacancy[5], db=selected_db, vacancy_hh_id=vacancy[0], page_source=pagination.page) }}">{{ vacancy[6] }}</a>
                                </td>
                                <td>{{ vacancy[12] }}</td>
                                <td class="text-center">
                                    <!-- Favorites checkbox form, AJAX -->
                                    <form class="favoriteForm" action="{{ url_for('update_content' )}}" method="post">
                                        <input type="hidden" name="db" value="{{ selected_db }}">
                                        <input type="hidden" name="vacancy_id" value="{{ vacancy[11] }}">

                                        <input class="form-check-input" type="checkbox" name="favorite_checkbox" value="{{ 1 if vacancy[9] == 1 else 0 }}" {{ 'checked' if vacancy[9] == 1 }}>
                                    </form>
                                    <!-- / Favorites checkbox form, AJAX -->
                                </td>
                                <td>
                                    <!-- Status list form, AJAX -->
                                    <form class="relationStatusForm" action="{{ url_for('update_content') }}" method="post">
                                        <input type="hidden" name="db" value="{{ selected_db }}">
                                        <input type="hidden" name="vacancy_id" value="{{ vacancy[11] }}">
                    
                                        <select name="relation_status" id="relation_status">
                                            <option value="None"></option>
                                            {% for status in status_list %}
                                                <option value="{{ status[0] }}" {% if vacancy[10] == status[0] %}selected{% endif %}>{{ status[1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                    <!-- / Status list form, AJAX -->
                                </td>
                                <td>{{ vacancy[7] }}</td>
                            </tr>
                            <tr>
                                <td colspan="10" class="table-light">
                                    {% set requirement = vacancy[8]['requirement'] if vacancy[8] else None %}
                                    {% set responsibility = vacancy[8]['responsibility'] if vacancy[8] else None %}

                                    <strong>Обязанности</strong>: {{ responsibility.replace('<highlighttext>', '').replace('</highlighttext>', '') if responsibility else None }}<br><br>
                                    <strong>Требования</strong>: {{ requirement.replace('<highlighttext>', '').replace('</highlighttext>', '') if requirement else None }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container my-4">
        <div class="row">
            <div class="col">
                <ul class="pagination">
                    {% for page_num in range(1, pagination.pages + 1) %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('index', db=selected_db, page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Change db name on database dropdown select -->
    <script>
        document.getElementById('db').addEventListener('change', function() {
            var selectedDb = this.value;
            window.location.href = "{{ url_for('index') }}?db=" + selectedDb;
        });
    </script>
    <!-- / Change db name on database dropdown select -->

    <!-- Send AJAX data to update_content on favorite checkbox trigger -->
    <script>
        $(document).ready(function() {
            $('.favoriteForm').change(function() {
                // Get the form data
                var form = $(this);
                var timestamp = new Date().getTime();  // Add timestamp

                // Get the value of the favorite_checkbox
                var checkboxValue = form.find('input[name="favorite_checkbox"]').prop('checked') ? '1' : '0';
                // Set the value of the favorite_checkbox field in the form data
                form.find('input[name="favorite_checkbox"]').val(checkboxValue);

                // Set the checkbox value explicitly in formData
                var formData = form.serialize();
                formData += '&favorite=' + checkboxValue;
                console.log(formData)

                // Make an AJAX request to the server
                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("update_content", t=timestamp) }}',
                    data: formData,
                    success: function(response) {
                        // Handle success, if needed
                        console.log('Form submitted successfully');
                    },
                    error: function(error) {
                        // Handle error, if needed
                        console.error('Error submitting form:', error);
                    }
                });
            });
        });
    </script>
    <!-- Send AJAX data to update_content on favorite checkbox trigger -->

    <!-- Send AJAX data to update_content on vacancy status change -->
    <script>
        $(document).ready(function() {
            $('.relationStatusForm').change(function() {
                // Get the form data
                var form = $(this);
                var formData = form.serialize();
                var timestamp = new Date().getTime();  // Add timestamp

                // Make an AJAX request to the server
                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("update_content", t=timestamp) }}',
                    data: formData,
                    success: function(response) {
                        // Handle success, if needed
                        console.log('Form submitted successfully');
                    },
                    error: function(error) {
                        // Handle error, if needed
                        console.error('Error submitting form:', error);
                    }
                });
            });
        });
    </script>
    <!-- Send AJAX data to update_content on vacancy status change -->

</body>
</html>